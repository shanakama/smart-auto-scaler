openapi: 3.0.3
info:
  title: DQN Kubernetes Resource Scaler API
  description: |
    A Flask-based REST API service that uses Deep Q-Network (DQN) machine learning 
    to automatically scale Kubernetes pod resources based on real-time metrics.
    
    The API provides endpoints for configuration management, pod scaling operations, 
    monitoring, and auto-scaling control using a multi-head DQN architecture for 
    separate CPU and Memory scaling decisions.
  version: 1.0.0
  contact:
    name: DQN Scaler Support
  license:
    name: MIT
    
servers:
  - url: http://localhost:5000
    description: Local development server
  - url: http://dqn-scaler:5000
    description: Kubernetes cluster service

tags:
  - name: Service Information
    description: Basic service information and health checks
  - name: Configuration
    description: Service configuration management
  - name: Pod Management
    description: Pod listing and information retrieval
  - name: Scaling Operations
    description: DQN-based scaling operations
  - name: Resource Management
    description: Direct pod resource resizing
  - name: Monitoring
    description: Scaling decisions and statistics
  - name: Auto-scaling
    description: Automatic scaling control
  - name: Model Information
    description: DQN model details and configuration

paths:
  /:
    get:
      tags:
        - Service Information
      summary: Get service information
      description: Returns basic service information and available endpoints
      responses:
        '200':
          description: Service information retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceInfo'

  /health:
    get:
      tags:
        - Service Information
      summary: Health check
      description: Health check endpoint to verify service status
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /config:
    get:
      tags:
        - Configuration
      summary: Get current configuration
      description: Retrieve current service configuration
      responses:
        '200':
          description: Configuration retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Configuration'
    
    post:
      tags:
        - Configuration
      summary: Update configuration
      description: Update service configuration with new values
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfigurationUpdate'
      responses:
        '200':
          description: Configuration updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigurationUpdateResponse'
        '400':
          description: Invalid configuration parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /pods:
    get:
      tags:
        - Pod Management
      summary: List all monitored pods
      description: List all monitored pods across configured namespaces
      responses:
        '200':
          description: Pods retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PodsResponse'
        '500':
          description: Error retrieving pods
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /pods/{namespace}/{pod_name}:
    get:
      tags:
        - Pod Management
      summary: Get specific pod information
      description: Get detailed information about a specific pod
      parameters:
        - name: namespace
          in: path
          required: true
          description: Kubernetes namespace
          schema:
            type: string
            example: default
        - name: pod_name
          in: path
          required: true
          description: Pod name
          schema:
            type: string
            example: nginx-deployment-abc123
      responses:
        '200':
          description: Pod information retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PodInfoResponse'
        '404':
          description: Pod not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Error retrieving pod information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /scale/pod/{namespace}/{pod_name}:
    post:
      tags:
        - Scaling Operations
      summary: Scale specific pod
      description: Process and potentially scale a specific pod using DQN model
      parameters:
        - name: namespace
          in: path
          required: true
          description: Kubernetes namespace
          schema:
            type: string
            example: default
        - name: pod_name
          in: path
          required: true
          description: Pod name
          schema:
            type: string
            example: nginx-deployment-abc123
      responses:
        '200':
          description: Pod scaling processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScalingResponse'
        '404':
          description: Pod not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Error processing pod scaling
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /scale/all:
    post:
      tags:
        - Scaling Operations
      summary: Scale all monitored pods
      description: Process and scale all monitored pods automatically
      responses:
        '200':
          description: All pods processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScaleAllResponse'
        '500':
          description: Error processing pods
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/namespaces/{namespace}/pods/{pod_name}/resize:
    post:
      tags:
        - Resource Management
      summary: Resize pod resources
      description: Resize pod container resources in-place using Kubernetes resize feature
      parameters:
        - name: namespace
          in: path
          required: true
          description: Kubernetes namespace
          schema:
            type: string
            example: default
        - name: pod_name
          in: path
          required: true
          description: Pod name
          schema:
            type: string
            example: nginx-deployment-abc123
        - name: enable_horizontal_fallback
          in: query
          required: false
          description: Enable fallback to deployment updates
          schema:
            type: boolean
            default: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResizeRequest'
      responses:
        '200':
          description: Pod resized successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResizeResponse'
        '400':
          description: Invalid resize parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Resize operation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Kubernetes client not available
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /decisions:
    get:
      tags:
        - Monitoring
      summary: Get recent scaling decisions
      description: Get recent scaling decisions across all pods
      parameters:
        - name: limit
          in: query
          required: false
          description: Maximum number of decisions to return
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 1000
      responses:
        '200':
          description: Scaling decisions retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DecisionsResponse'
        '500':
          description: Error retrieving decisions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /statistics:
    get:
      tags:
        - Monitoring
      summary: Get scaling statistics
      description: Get comprehensive scaling statistics and performance metrics
      responses:
        '200':
          description: Statistics retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatisticsResponse'
        '500':
          description: Error retrieving statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /autoscale/start:
    post:
      tags:
        - Auto-scaling
      summary: Start automatic scaling
      description: Start the automatic scaling service
      responses:
        '200':
          description: Auto-scaling started successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AutoscaleStartResponse'
        '500':
          description: Error starting auto-scaling
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /autoscale/stop:
    post:
      tags:
        - Auto-scaling
      summary: Stop automatic scaling
      description: Stop the automatic scaling service
      responses:
        '200':
          description: Auto-scaling stopped successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AutoscaleStopResponse'
        '500':
          description: Error stopping auto-scaling
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /autoscale/status:
    get:
      tags:
        - Auto-scaling
      summary: Get auto-scaler status
      description: Get current auto-scaling status
      responses:
        '200':
          description: Auto-scaler status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AutoscaleStatusResponse'

  /model/info:
    get:
      tags:
        - Model Information
      summary: Get DQN model information
      description: Get information about the DQN model and its configuration
      responses:
        '200':
          description: Model information retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModelInfoResponse'

components:
  schemas:
    ServiceInfo:
      type: object
      properties:
        service:
          type: string
          example: "DQN Kubernetes Resource Scaler"
        version:
          type: string
          example: "1.0.0"
        model:
          type: string
          example: "Deep Q-Network (DQN)"
        endpoints:
          type: object
          additionalProperties:
            type: string
          example:
            "GET /health": "Health check"
            "GET /config": "Get current configuration"
            "POST /config": "Update configuration"

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: "healthy"
        service:
          type: string
          example: "dqn-scaler"
        timestamp:
          type: string
          format: date-time
          example: "2024-12-18T10:30:00.000Z"

    Configuration:
      type: object
      properties:
        model_path:
          type: string
          example: "final-models/dqn_model.pth"
        state_dim:
          type: integer
          example: 8
        action_dim:
          type: integer
          example: 3
        history_window:
          type: integer
          example: 5
        min_cpu:
          type: number
          format: float
          example: 0.1
        max_cpu:
          type: number
          format: float
          example: 8.0
        min_memory:
          type: integer
          example: 20
        max_memory:
          type: integer
          example: 16384
        scale_factor:
          type: number
          format: float
          example: 0.2
        dry_run:
          type: boolean
          example: true
        in_cluster:
          type: boolean
          example: false
        namespaces:
          type: array
          items:
            type: string
          example: ["default"]
        auto_scale_enabled:
          type: boolean
          example: true
        auto_scale_interval:
          type: integer
          example: 30
        scaling_cooldown:
          type: integer
          example: 30
        excluded_deployments:
          type: array
          items:
            type: string
          example: ["redis", "dqn-scaler", "metrics-collector"]
        excluded_labels:
          type: object
          additionalProperties:
            type: string
          example:
            app: "redis"
            component: "redis"

    ConfigurationUpdate:
      type: object
      properties:
        dry_run:
          type: boolean
        auto_scale_enabled:
          type: boolean
        auto_scale_interval:
          type: integer
          minimum: 10
        scale_factor:
          type: number
          format: float
          minimum: 0.1
          maximum: 1.0
        scaling_cooldown:
          type: integer
          minimum: 1
        namespaces:
          type: array
          items:
            type: string
        excluded_deployments:
          type: array
          items:
            type: string
        excluded_labels:
          type: object
          additionalProperties:
            type: string

    ConfigurationUpdateResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Configuration updated"
        config:
          $ref: '#/components/schemas/Configuration'

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          example: "Error message description"

    PodContainer:
      type: object
      properties:
        name:
          type: string
          example: "nginx"
        image:
          type: string
          example: "nginx:1.21"
        resources:
          type: object
          properties:
            requests:
              type: object
              additionalProperties:
                type: string
              example:
                cpu: "100m"
                memory: "128Mi"
            limits:
              type: object
              additionalProperties:
                type: string
              example:
                cpu: "500m"
                memory: "512Mi"

    PodOwner:
      type: object
      properties:
        kind:
          type: string
          example: "ReplicaSet"
        name:
          type: string
          example: "nginx-deployment-xyz789"

    Pod:
      type: object
      properties:
        name:
          type: string
          example: "nginx-deployment-abc123"
        namespace:
          type: string
          example: "default"
        status:
          type: string
          example: "Running"
        creation_timestamp:
          type: string
          format: date-time
          example: "2024-12-18T10:00:00.000Z"
        labels:
          type: object
          additionalProperties:
            type: string
          example:
            app: "nginx"
            version: "1.0"
        node_name:
          type: string
          example: "worker-node-1"
        pod_ip:
          type: string
          example: "10.244.1.5"
        containers:
          type: array
          items:
            $ref: '#/components/schemas/PodContainer'
        owner:
          $ref: '#/components/schemas/PodOwner'

    PodsResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        count:
          type: integer
          example: 5
        pods:
          type: array
          items:
            $ref: '#/components/schemas/Pod'

    PodMetrics:
      type: object
      properties:
        cpu_usage_cores:
          type: number
          format: float
          example: 0.15
        memory_usage_mb:
          type: number
          format: float
          example: 256.5

    PodResources:
      type: object
      properties:
        cpu_requests_cores:
          type: number
          format: float
          example: 0.1
        memory_requests_mb:
          type: number
          format: float
          example: 128

    PodInfoResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        pod:
          type: string
          example: "default/nginx-deployment-abc123"
        metrics:
          $ref: '#/components/schemas/PodMetrics'
        resources:
          $ref: '#/components/schemas/PodResources'

    ResourceChange:
      type: object
      properties:
        current:
          type: number
          format: float
          example: 0.5
        new:
          type: number
          format: float
          example: 0.6
        change_percent:
          type: number
          format: float
          example: 20.0
        action:
          type: string
          enum: ["DECREASE", "MAINTAIN", "INCREASE"]
          example: "INCREASE"

    ScalingPrediction:
      type: object
      properties:
        cpu_action:
          type: string
          enum: ["DECREASE", "MAINTAIN", "INCREASE"]
          example: "INCREASE"
        memory_action:
          type: string
          enum: ["DECREASE", "MAINTAIN", "INCREASE"]
          example: "MAINTAIN"
        cpu_action_index:
          type: integer
          enum: [0, 1, 2]
          example: 2
        memory_action_index:
          type: integer
          enum: [0, 1, 2]
          example: 1

    Confidence:
      type: object
      properties:
        cpu:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          example: 0.85
        memory:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          example: 0.92

    FuturePredictions:
      type: object
      properties:
        next_step_cpu:
          type: number
          format: float
          example: 0.18
        next_step_memory:
          type: number
          format: float
          example: 250.0

    QValues:
      type: object
      properties:
        cpu_q_values:
          type: array
          items:
            type: number
            format: float
          minItems: 3
          maxItems: 3
          example: [0.1, 0.3, 0.9]
        memory_q_values:
          type: array
          items:
            type: number
            format: float
          minItems: 3
          maxItems: 3
          example: [0.2, 0.95, 0.4]

    Explanation:
      type: object
      properties:
        reasoning:
          type: string
          example: "High CPU utilization detected. Memory usage is stable."
        factors:
          type: array
          items:
            type: string
          example: ["cpu_trend_increasing", "memory_stable"]

    ScalingDecision:
      type: object
      properties:
        pod_name:
          type: string
          example: "nginx-deployment-abc123"
        namespace:
          type: string
          example: "default"
        timestamp:
          type: string
          format: date-time
          example: "2024-12-18T10:30:00.000Z"
        current_metrics:
          type: object
          properties:
            cpu_usage:
              type: number
              format: float
              example: 0.15
            memory_usage_mb:
              type: number
              format: float
              example: 256.5
            cpu_limit:
              type: number
              format: float
              example: 0.5
            memory_limit_mb:
              type: number
              format: float
              example: 512.0
        predictions:
          $ref: '#/components/schemas/ScalingPrediction'
        confidence:
          $ref: '#/components/schemas/Confidence'
        future_predictions:
          $ref: '#/components/schemas/FuturePredictions'
        q_values:
          $ref: '#/components/schemas/QValues'
        resource_changes:
          type: object
          properties:
            cpu:
              $ref: '#/components/schemas/ResourceChange'
            memory:
              $ref: '#/components/schemas/ResourceChange'
        can_scale:
          type: boolean
          example: true
        explanation:
          $ref: '#/components/schemas/Explanation'
        reasoning:
          type: string
          example: "High CPU utilization detected. Memory usage is stable."

    ScalingResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        result:
          $ref: '#/components/schemas/ScalingDecision'

    ScalingResult:
      type: object
      properties:
        pod_name:
          type: string
          example: "nginx-deployment-abc123"
        status:
          type: string
          enum: ["success", "failed", "skipped", "no_action_needed", "dry_run", "error"]
          example: "success"
        message:
          type: string
          example: "Scaling executed successfully"
        reason:
          type: string
          example: "cooldown_period"
        actions:
          type: object
          properties:
            cpu:
              type: string
              enum: ["DECREASE", "MAINTAIN", "INCREASE"]
              example: "INCREASE"
            memory:
              type: string
              enum: ["DECREASE", "MAINTAIN", "INCREASE"]
              example: "MAINTAIN"
        error:
          type: string

    ActionDistribution:
      type: object
      properties:
        cpu_actions:
          type: object
          properties:
            DECREASE:
              type: integer
              example: 10
            MAINTAIN:
              type: integer
              example: 80
            INCREASE:
              type: integer
              example: 60
        memory_actions:
          type: object
          properties:
            DECREASE:
              type: integer
              example: 5
            MAINTAIN:
              type: integer
              example: 120
            INCREASE:
              type: integer
              example: 25

    StatisticsOverview:
      type: object
      properties:
        total_decisions:
          type: integer
          example: 150
        total_pods_monitored:
          type: integer
          example: 8
        applied_scalings:
          type: integer
          example: 45
        scaling_rate:
          type: number
          format: float
          example: 30.0

    Statistics:
      type: object
      properties:
        overview:
          $ref: '#/components/schemas/StatisticsOverview'
        action_distribution:
          $ref: '#/components/schemas/ActionDistribution'

    ScaleAllResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        processed:
          type: integer
          example: 3
        results:
          type: array
          items:
            $ref: '#/components/schemas/ScalingResult'
        statistics:
          $ref: '#/components/schemas/Statistics'
        timestamp:
          type: string
          format: date-time
          example: "2024-12-18T10:30:00.000Z"

    ContainerResourceSpec:
      type: object
      properties:
        requests:
          type: object
          properties:
            cpu:
              type: string
              pattern: '^(\d+(\.\d+)?|\d+m)$'
              example: "200m"
            memory:
              type: string
              pattern: '^(\d+(\.\d+)?(Ki|Mi|Gi))$'
              example: "256Mi"
        limits:
          type: object
          properties:
            cpu:
              type: string
              pattern: '^(\d+(\.\d+)?|\d+m)$'
              example: "800m"
            memory:
              type: string
              pattern: '^(\d+(\.\d+)?(Ki|Mi|Gi))$'
              example: "1Gi"

    ResizeRequest:
      type: object
      required:
        - containers
      properties:
        containers:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/ContainerResourceSpec'
          example:
            nginx:
              requests:
                cpu: "200m"
                memory: "256Mi"
              limits:
                cpu: "800m"
                memory: "1Gi"

    ResizeResponse:
      type: object
      properties:
        message:
          type: string
          example: "Successfully resized pod nginx-deployment-abc123 vertically"
        pod:
          type: string
          example: "nginx-deployment-abc123"
        namespace:
          type: string
          example: "default"
        scaling_method:
          type: string
          enum: ["vertical", "deployment_update"]
          example: "vertical"
        details:
          type: object
        timestamp:
          type: string
          format: date-time
          example: "2024-12-18T10:30:00.000Z"

    DecisionWithUtilization:
      allOf:
        - $ref: '#/components/schemas/ScalingDecision'
        - type: object
          properties:
            utilization:
              type: object
              properties:
                cpu_percentage:
                  type: number
                  format: float
                  example: 30.0
                memory_percentage:
                  type: number
                  format: float
                  example: 50.1

    DecisionsResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        count:
          type: integer
          example: 25
        decisions:
          type: array
          items:
            $ref: '#/components/schemas/DecisionWithUtilization'

    StatisticsResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        statistics:
          type: object
          properties:
            overview:
              $ref: '#/components/schemas/StatisticsOverview'
            action_distribution:
              $ref: '#/components/schemas/ActionDistribution'
            resource_utilization:
              type: object
              properties:
                average_cpu_usage:
                  type: number
                  format: float
                  example: 0.45
                average_memory_usage_mb:
                  type: number
                  format: float
                  example: 512.75
            model_performance:
              type: object
              properties:
                average_cpu_confidence:
                  type: number
                  format: float
                  example: 0.87
                average_memory_confidence:
                  type: number
                  format: float
                  example: 0.91
                model_type:
                  type: string
                  example: "Multi-Head DQN"
            system_status:
              type: object
              properties:
                dry_run_mode:
                  type: boolean
                  example: false
                cooldown_period_minutes:
                  type: integer
                  example: 5
                scale_factor:
                  type: number
                  format: float
                  example: 0.2
                kubernetes_available:
                  type: boolean
                  example: true
            timestamp:
              type: string
              format: date-time
              example: "2024-12-18T10:30:00.000Z"

    AutoscaleStartResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Auto-scaling started"
        interval:
          type: integer
          example: 30

    AutoscaleStopResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Auto-scaling stopped"

    AutoscaleStatusResponse:
      type: object
      properties:
        enabled:
          type: boolean
          example: true
        running:
          type: boolean
          example: true
        interval_seconds:
          type: integer
          example: 30
        thread_alive:
          type: boolean
          example: true

    ModelInfoResponse:
      type: object
      properties:
        model_type:
          type: string
          example: "Deep Q-Network (DQN)"
        model_path:
          type: string
          example: "final-models/dqn_model.pth"
        state_dim:
          type: integer
          example: 8
        action_dim:
          type: integer
          example: 3
        actions:
          type: object
          properties:
            "0":
              type: string
              example: "DECREASE"
            "1":
              type: string
              example: "MAINTAIN"
            "2":
              type: string
              example: "INCREASE"
        state_features:
          type: array
          items:
            type: string
          example:
            - "CPU usage (normalized)"
            - "Memory usage (normalized)"
            - "Network latency (placeholder)"
            - "Container count (normalized)"
            - "CPU trend"
            - "Memory trend"
            - "CPU allocation (normalized)"
            - "Memory allocation (normalized)"